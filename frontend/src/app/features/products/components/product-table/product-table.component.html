<div class="card">
  <div class="font-semibold text-xl mb-4">{{ 'products.title' | translate }}</div>
  <p-table
    #dt1
    [value]="dataService.products()"
    [lazy]="true"
    [rows]="10"
    [totalRecords]="dataService.totalRecords()"
    [loading]="dataService.isLoading()"
    [rowHover]="true"
    [showGridlines]="true"
    [paginator]="true"
    [rowsPerPageOptions]="[10,25,50,100]"
    [showCurrentPageReport]="true"
    [currentPageReportTemplate]="('products.pageReport' | translate)"
    [globalFilterFields]="getColumnFieldNames()"
    [selection]="selectedProducts()"
    (selectionChange)="selectedProducts.set($event)"
    dataKey="id"
    (onLazyLoad)="onLazyLoad($event)"
    styleClass="p-datatable-gridlines"
  >
    <ng-template pTemplate="caption">
      <div class="flex justify-content-between align-items-center flex-column sm:flex-row">
        <div class="flex gap-2">
          <p-button [label]="'products.btnDelete' | translate" icon="pi pi-trash" severity="danger" [disabled]="!selectedProducts().length" (onClick)="deleteSelectedProducts()" />
          <p-button [label]="'products.btnCustomFilters' | translate" icon="pi pi-filter" severity="secondary" [outlined]="true" (onClick)="openFilterBuilder()" />
          <p-button [label]="'products.btnExport' | translate" icon="pi pi-file-excel" severity="secondary" [outlined]="true" (onClick)="exportExcel()" />
          <button pButton label="Clear" class="p-button-outlined" icon="pi pi-filter-slash" (click)="clear(dt1)"></button>
        </div>
        <span class="p-input-icon-left ml-auto">
          <i class="pi pi-search"></i>
          <input pInputText type="text" (input)="onGlobalFilter(dt1, $event)" [placeholder]="'products.searchPlaceholder' | translate" />
        </span>
      </div>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        <th style="width: 4rem"><p-tableHeaderCheckbox /></th>
        @for (column of schemaService.visibleColumns(); track column.name) {
          <th style="min-width: 12rem">
            <div class="flex justify-content-between align-items-center">
              {{ column.displayName }}
              <p-columnFilter type="text" [field]="column.name" display="menu" [placeholder]="'Search by ' + column.displayName.toLowerCase()"></p-columnFilter>
            </div>
          </th>
        }
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-product>
      <tr>
        <td><p-tableCheckbox [value]="product" /></td>
        @for (column of schemaService.visibleColumns(); track column.name) {
          <td>
            @if (column.type === 'MINIO_IMAGE') {
              @if (product[column.name]) {
                <img [src]="product[column.name]" [alt]="column.displayName" class="product-image" style="width: 50px; height: 50px; object-fit: cover;" />
              } @else {
                <span class="text-500">{{ 'products.noImage' | translate }}</span>
              }
            } @else if (column.type === 'BOOLEAN') {
              <i [class]="product[column.name] ? 'pi pi-check text-green-500' : 'pi pi-times text-red-500'"></i>
            } @else if (column.type === 'DATE') {
              {{ product[column.name] | date:'short' }}
            } @else if (column.type === 'DECIMAL') {
              {{ product[column.name] | number:'1.2-2' }}
            } @else {
              {{ product[column.name] }}
            }
          </td>
        }
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td [attr.colspan]="schemaService.visibleColumns().length + 1">
          <div class="flex align-items-center justify-content-center flex-column p-5">
            <i class="pi pi-inbox text-6xl text-400 mb-3"></i>
            <p class="text-600">{{ 'products.noResults' | translate }}</p>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="loadingbody">
      <tr>
        <td [attr.colspan]="schemaService.visibleColumns().length + 1">
          <div class="flex align-items-center justify-content-center p-3">
            <i class="pi pi-spin pi-spinner mr-2"></i>
            <span>{{ 'products.loading' | translate }}</span>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<p-dialog [header]="('products.filterBuilderTitle' | translate)" [(visible)]="showFilterBuilder" [modal]="true" [style]="{ width: '50vw' }" [draggable]="false" [resizable]="false">
  <app-custom-filter-builder (filterApplied)="onFilterApplied()" (cancel)="showFilterBuilder.set(false)" />
</p-dialog>

<p-confirmDialog [acceptLabel]="'common.yes' | translate" [rejectLabel]="'common.no' | translate" />
<p-toast />
