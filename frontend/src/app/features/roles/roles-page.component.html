<div class="roles-page">
  <div class="grid gap-4">
    <!-- Permissions -->
    <div class="col-12">
      <p-card [header]="'rolesPage.permissions.title' | translate" class="section-card fullwidth-table">
        <div class="section-toolbar">
          <button pButton type="button" icon="pi pi-plus" [label]="'rolesPage.permissions.add' | translate" (click)="openPermissionDialog()"></button>
        </div>
        <p-table
          [value]="permissions"
          [loading]="permissionsLoading"
          responsiveLayout="scroll"
          size="small"
          [rows]="5"
          [paginator]="permissions.length > 5"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>{{ 'rolesPage.permissions.columns.name' | translate }}</th>
              <th style="width: 7rem;">{{ 'rolesPage.common.actions' | translate }}</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-permission>
            <tr>
              <td>{{ permission.name }}</td>
              <td class="actions-column">
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-rounded p-button-text"
                  (click)="openPermissionDialog(permission)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-text p-button-danger"
                  (click)="confirmDeletePermission(permission)"
                ></button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="2">{{ 'rolesPage.permissions.empty' | translate }}</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>

    <!-- Roles -->
    <div class="col-12">
      <p-card [header]="'rolesPage.roles.title' | translate" class="section-card fullwidth-table">
        <div class="section-toolbar">
          <button pButton type="button" icon="pi pi-plus" [label]="'rolesPage.roles.add' | translate" (click)="openRoleDialog()"></button>
        </div>
        <p-table
          [value]="roles"
          [loading]="rolesLoading"
          responsiveLayout="scroll"
          size="small"
          [rows]="5"
          [paginator]="roles.length > 5"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>{{ 'rolesPage.roles.columns.name' | translate }}</th>
              <th class="permissions-column">{{ 'rolesPage.roles.columns.permissions' | translate }}</th>
              <th style="width: 10rem;">{{ 'rolesPage.common.actions' | translate }}</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-role>
            <tr>
              <td>{{ role.name }}</td>
              <td>
                <div
                  class="tag-wrap"
                  [attr.title]="getRolePermissionTooltip(role)"
                >
                  <p-tag
                    *ngFor="let perm of getRolePermissionsDisplay(role); trackBy: trackById"
                    [value]="perm.name"
                    severity="info"
                  ></p-tag>
                  <span
                    class="tag-overflow"
                    *ngIf="getRolePermissionsOverflow(role) as overflow"
                    [attr.title]="getRolePermissionTooltip(role)"
                  >
                    {{ 'rolesPage.common.more' | translate: { count: overflow } }}
                  </span>
                </div>
              </td>
              <td class="actions-column">
                <button
                  pButton
                  type="button"
                  icon="pi pi-link"
                  class="p-button-rounded p-button-text"
                  (click)="openRolePermissionsDialog(role)"
                  [title]="'rolesPage.roles.tooltips.attachPermissions' | translate"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-rounded p-button-text"
                  (click)="openRoleDialog(role)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-text p-button-danger"
                  (click)="confirmDeleteRole(role)"
                ></button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="3">{{ 'rolesPage.roles.empty' | translate }}</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>

    <!-- Users -->
    <div class="col-12">
      <p-card [header]="'rolesPage.users.title' | translate" class="section-card fullwidth-table">
        <div class="section-toolbar">
          <button pButton type="button" icon="pi pi-plus" [label]="'rolesPage.users.add' | translate" (click)="openUserDialog()"></button>
        </div>
        <p-table
          [value]="users"
          [loading]="usersLoading"
          responsiveLayout="scroll"
          size="small"
          [rows]="5"
          [paginator]="users.length > 5"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>{{ 'rolesPage.users.columns.username' | translate }}</th>
              <th>{{ 'rolesPage.users.columns.email' | translate }}</th>
              <th>{{ 'rolesPage.users.columns.status' | translate }}</th>
              <th class="users-roles-column">{{ 'rolesPage.users.columns.roles' | translate }}</th>
              <th style="width: 10rem;">{{ 'rolesPage.common.actions' | translate }}</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-user>
            <tr>
              <td>{{ user.username }}</td>
              <td>{{ user.email || 'â€”' }}</td>
              <td>
                <p-tag
                  [value]="user.enabled ? ('rolesPage.statuses.enabled' | translate) : ('rolesPage.statuses.disabled' | translate)"
                  [severity]="user.enabled ? 'success' : 'danger'"
                ></p-tag>
              </td>
              <td>
                <div class="tag-wrap" [attr.title]="getUserRolesTooltip(user)">
                  <p-tag
                    *ngFor="let role of getUserRolesDisplay(user); trackBy: trackById"
                    [value]="role.name"
                    severity="info"
                  ></p-tag>
                  <span
                    class="tag-overflow"
                    *ngIf="getUserRolesOverflow(user) as overflow"
                    [attr.title]="getUserRolesTooltip(user)"
                  >
                    {{ 'rolesPage.common.more' | translate: { count: overflow } }}
                  </span>
                </div>
              </td>
              <td class="actions-column">
                <button
                  pButton
                  type="button"
                  icon="pi pi-link"
                  class="p-button-rounded p-button-text"
                  (click)="openUserRolesDialog(user)"
                  [title]="'rolesPage.users.tooltips.attachRoles' | translate"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-rounded p-button-text"
                  (click)="openUserDialog(user)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-text p-button-danger"
                  (click)="confirmDeleteUser(user)"
                ></button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5">{{ 'rolesPage.users.empty' | translate }}</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>
  </div>
</div>

<!-- Permission dialog -->
<p-dialog
  [header]="(editingPermission ? 'rolesPage.permissions.dialogs.editTitle' : 'rolesPage.permissions.dialogs.createTitle') | translate"
  [(visible)]="permissionDialogVisible"
  [modal]="true"
  [style]="{ width: '25rem' }"
  [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
>
  <form [formGroup]="permissionForm" class="form-grid">
    <div class="form-field">
      <label class="field-label" for="permissionName">
        {{ 'rolesPage.permissions.form.nameLabel' | translate }}
        <span class="required-indicator">*</span>
      </label>
      <input pInputText id="permissionName" formControlName="name" />
    </div>
    <small class="error" *ngIf="permissionForm.controls['name'].invalid && permissionForm.controls['name'].touched">
      {{ 'rolesPage.permissions.form.nameRequired' | translate }}
    </small>
  </form>
  <ng-template pTemplate="footer">
    <button pButton type="button" [label]="'rolesPage.common.cancel' | translate" class="p-button-text" (click)="permissionDialogVisible = false"></button>
    <button pButton type="button" [label]="'rolesPage.common.save' | translate" (click)="savePermission()"></button>
  </ng-template>
</p-dialog>

<!-- Role dialog -->
<p-dialog
  [header]="(editingRole ? 'rolesPage.roles.dialogs.editTitle' : 'rolesPage.roles.dialogs.createTitle') | translate"
  [(visible)]="roleDialogVisible"
  [modal]="true"
  [style]="{ width: '25rem' }"
  [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
>
  <form [formGroup]="roleForm" class="form-grid">
    <div class="form-field">
      <label class="field-label" for="roleName">
        {{ 'rolesPage.roles.form.nameLabel' | translate }}
        <span class="required-indicator">*</span>
      </label>
      <input pInputText id="roleName" formControlName="name" />
    </div>
    <small class="error" *ngIf="roleForm.controls['name'].invalid && roleForm.controls['name'].touched">
      {{ 'rolesPage.roles.form.nameRequired' | translate }}
    </small>
  </form>
  <ng-template pTemplate="footer">
    <button pButton type="button" [label]="'rolesPage.common.cancel' | translate" class="p-button-text" (click)="roleDialogVisible = false"></button>
    <button pButton type="button" [label]="'rolesPage.common.save' | translate" (click)="saveRole()"></button>
  </ng-template>
</p-dialog>

<!-- User dialog -->
<p-dialog
  [header]="(editingUser ? 'rolesPage.users.dialogs.editTitle' : 'rolesPage.users.dialogs.createTitle') | translate"
  [(visible)]="userDialogVisible"
  [modal]="true"
  [style]="{ width: '28rem' }"
  [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
>
  <form [formGroup]="userForm" class="form-grid">
    <div class="form-field">
      <label class="field-label" for="username">
        {{ 'rolesPage.users.form.usernameLabel' | translate }}
        <span class="required-indicator">*</span>
      </label>
      <input pInputText id="username" formControlName="username" />
    </div>
    <small class="error" *ngIf="userForm.controls['username'].invalid && userForm.controls['username'].touched">
      {{ 'rolesPage.users.form.usernameRequired' | translate }}
    </small>

    <div class="form-field">
      <label class="field-label" for="email">{{ 'rolesPage.users.form.emailLabel' | translate }}</label>
      <input pInputText id="email" formControlName="email" type="email" />
    </div>
    <small class="error" *ngIf="userForm.controls['email'].invalid && userForm.controls['email'].touched">
      {{ 'rolesPage.users.form.emailInvalid' | translate }}
    </small>

    <div class="form-field">
      <label class="field-label" for="password">
        {{ editingUser ? ('rolesPage.users.form.passwordOptional' | translate) : ('rolesPage.users.form.passwordLabel' | translate) }}
        <span class="required-indicator" *ngIf="!editingUser">*</span>
      </label>
      <input pInputText id="password" formControlName="password" type="password" autocomplete="new-password" />
    </div>
    <small class="error" *ngIf="userForm.controls['password'].invalid && userForm.controls['password'].touched">
      {{ 'rolesPage.users.form.passwordRequired' | translate }}
    </small>

    <div class="checkbox-field">
      <p-checkbox formControlName="enabled" inputId="enabled" [binary]="true"></p-checkbox>
      <label for="enabled">{{ 'rolesPage.users.form.enabled' | translate }}</label>
    </div>
  </form>
  <ng-template pTemplate="footer">
    <button pButton type="button" [label]="'rolesPage.common.cancel' | translate" class="p-button-text" (click)="userDialogVisible = false"></button>
    <button pButton type="button" [label]="'rolesPage.common.save' | translate" (click)="saveUser()"></button>
  </ng-template>
</p-dialog>

<!-- Role permissions picklist -->
<p-dialog
  [header]="'rolesPage.roles.picklist.title' | translate"
  [(visible)]="rolePermissionsDialogVisible"
  [modal]="true"
  [style]="{ width: '45rem' }"
  [breakpoints]="{ '960px': '95vw', '640px': '95vw' }"
>
  <p-pickList
    [source]="rolePickListSource"
    [target]="rolePickListTarget"
    [sourceHeader]="'rolesPage.picklist.available' | translate"
    [targetHeader]="'rolesPage.picklist.assigned' | translate"
    filterBy="name"
    [showSourceControls]="false"
    [showTargetControls]="false"
    [metaKeySelection]="false"
    [responsive]="true"
  >
    <ng-template let-item pTemplate="item">
      <div class="picklist-item">{{ item.name }}</div>
    </ng-template>
  </p-pickList>
  <ng-template pTemplate="footer">
    <button pButton type="button" [label]="'rolesPage.common.cancel' | translate" class="p-button-text" (click)="rolePermissionsDialogVisible = false"></button>
    <button pButton type="button" [label]="'rolesPage.common.save' | translate" (click)="saveRolePermissions()"></button>
  </ng-template>
</p-dialog>

<!-- User roles picklist -->
<p-dialog
  [header]="'rolesPage.users.picklist.title' | translate"
  [(visible)]="userRolesDialogVisible"
  [modal]="true"
  [style]="{ width: '38rem' }"
  [breakpoints]="{ '960px': '95vw', '640px': '95vw' }"
>
  <p-pickList
    [source]="userPickListSource"
    [target]="userPickListTarget"
    [sourceHeader]="'rolesPage.picklist.available' | translate"
    [targetHeader]="'rolesPage.picklist.selected' | translate"
    filterBy="name"
    [showSourceControls]="false"
    [showTargetControls]="false"
    [metaKeySelection]="false"
    [responsive]="true"
    (onMoveToTarget)="handleUserRolesMoveToTarget()"
  >
    <ng-template let-item pTemplate="item">
      <div class="picklist-item">{{ item.name }}</div>
    </ng-template>
  </p-pickList>
  <small class="info-text">{{ 'rolesPage.users.picklist.info' | translate }}</small>
  <ng-template pTemplate="footer">
    <button pButton type="button" [label]="'rolesPage.common.cancel' | translate" class="p-button-text" (click)="userRolesDialogVisible = false"></button>
    <button pButton type="button" [label]="'rolesPage.common.save' | translate" (click)="saveUserRoles()"></button>
  </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
