<div class="card">
    <div class="font-semibold text-xl mb-4" *ngIf="showTitle">{{ (translationPrefix + '.title') | translate }}</div>

    <div class="card">
        <p-table
            #dt1
            styleClass="hybrid-table"
            [value]="dataService.records()"
            dataKey="id"
            [rowsPerPageOptions]="[10, 25, 50]"
            [loading]="loading"
            [paginator]="true"
            [lazy]="true"
            [rows]="rows"
            [totalRecords]="totalRecords"
            [first]="first"
            [tableStyle]="{ 'min-width': '1200px' }"
            [scrollable]="true"
            scrollDirection="horizontal"
            [globalFilterFields]="globalFilterFields"
            (onLazyLoad)="onLazyLoad($event)"
            (onSort)="onSort($event)"
        >
            <!-- CAPTION -->
            <ng-template pTemplate="caption">
                <div class="caption-toolbar">
                    <div class="caption-row caption-row--top">
                        <div class="caption-row__left">
                            <p-iconfield iconPosition="left" class="search-field">
                                <p-inputicon>
                                    <i class="pi pi-search"></i>
                                </p-inputicon>
                                <input
                                        pInputText
                                        type="text"
                                        [(ngModel)]="searchValue"
                                        (input)="onGlobalFilter($event, dt1)"
                                        [placeholder]="(translationPrefix + '.searchPlaceholder') | translate:{ component: schemaService.displayName() }"
                                />
                            </p-iconfield>
                            <p-button
                                    *ngIf="canExport"
                                    [label]="(translationPrefix + '.exportExcel') | translate"
                                    icon="pi pi-file-excel"
                                    severity="success"
                                    (click)="onExportExcel()"
                                    [disabled]="!hasRows"
                                    [title]="(translationPrefix + '.exportExcelTooltip') | translate"
                            ></p-button>
                        </div>
                        <div class="caption-row__right" *ngIf="showPrimaryActions">
                            <p-button
                                    *ngIf="showTakeOrderButton"
                                    class="take-order-button"
                                    [label]="'orders.takeOrder.cta' | translate"
                                    icon="pi pi-user-plus"
                                    [outlined]="true"
                                    severity="info"
                                    [loading]="takeOrderLoading || agentWorkloadLoading"
                                    [disabled]="takeOrderDisabled"
                                    [title]="takeOrderTitle"
                                    (click)="takeNextOrder()"
                            ></p-button>
                            <p-button
                                    *ngIf="canAdd"
                                    [label]="(translationPrefix + '.newItem') | translate"
                                    icon="pi pi-plus"
                                    (click)="openCreateDialog()"
                            ></p-button>
                        </div>
                    </div>
                    <div class="caption-row caption-row--bottom">
                        <div class="caption-row__left">
                            <p-button
                                    [label]="'common.clear' | translate"
                                    [outlined]="true"
                                    icon="pi pi-filter-slash"
                                    (click)="clear(dt1)"
                            ></p-button>
                            <p-multiselect
                                    class="column-toggle"
                                    [options]="columnToggleOptions"
                                    [(ngModel)]="selectedColumnKeys"
                                    optionLabel="label"
                                    optionValue="value"
                                    display="chip"
                                    [showToggleAll]="false"
                                    [placeholder]="(translationPrefix + '.columnTogglePlaceholder') | translate"
                                    [selectedItemsLabel]="columnToggleSelectedItemsLabel"
                                    (onChange)="onColumnToggleChange($event.value)"
                            ></p-multiselect>
                            <p-button
                                    *ngIf="primaryDateField"
                                    class="date-range-trigger"
                                    icon="pi pi-calendar"
                                    [label]="dateRangeLabel"
                                    [outlined]="true"
                                    severity="success"
                                    (click)="dateRangePanel.toggle($event)"
                            ></p-button>
                            <p-select
                                    *ngIf="isOrdersContext && statusOptions.length && statusColumnName"
                                    class="status-quick-filter"
                                    [options]="statusOptions"
                                    optionLabel="label"
                                    optionValue="value"
                                    [showClear]="true"
                                    [placeholder]="statusColumnDisplayName"
                                    [(ngModel)]="statusQuickFilter"
                                    (onChange)="applyQuickStatusFilter($event.value)"
                            ></p-select>
                        </div>
                        <div class="caption-row__right">
                            <p-button
                                    *ngIf="canEdit"
                                    [label]="'common.reorderColumns' | translate"
                                    icon="pi pi-sort"
                                    class="p-button-outlined"
                                    (click)="openColumnReorderDialog()"
                            ></p-button>
                        </div>
                    </div>
                    <p-overlayPanel #dateRangePanel styleClass="date-range-panel" [dismissable]="true" [showCloseIcon]="true">
                        <div class="date-range-content">
                            <div class="date-range-presets">
                                <button
                                        type="button"
                                        class="preset-button"
                                        *ngFor="let preset of dateRangePresets"
                                        [class.active]="activeDatePreset === preset.key"
                                        (click)="applyDatePreset(preset.key)"
                                >
                                    {{ preset.label | translate }}
                                </button>
                                <button
                                        type="button"
                                        class="preset-button preset-clear"
                                        (click)="clearDateRangeFilter()"
                                >
                                    {{ 'common.clear' | translate }}
                                </button>
                            </div>
                            <div class="date-range-picker">
                                <p-datepicker
                                        [(ngModel)]="dateRange"
                                        (ngModelChange)="onDateRangeChange($event)"
                                        selectionMode="range"
                                        [manualInput]="false"
                                        [numberOfMonths]="2"
                                        [inline]="true"
                                ></p-datepicker>
                            </div>
                        </div>
                    </p-overlayPanel>
                </div>
            </ng-template>

            <!-- HEADER with dynamic columns and per-column filter UIs -->
            <ng-template pTemplate="header">
                <tr>
                    @for (column of schemaService.visibleColumns(); track column.name) {
                        @if (!isColumnHidden(column.name)) {
                            @if (column.type === ColumnType.MINIO_IMAGE) {
                                <th [style.min-width]="'10rem'">
                                    <div class="header-cell">
                                        <span class="header-title">{{ column.displayName }}</span>
                                    </div>
                                </th>
                            } @else {
                                <th
                                        [pSortableColumn]="column.name"
                                        [style.min-width]="column.type === ColumnType.TEXT ? '15rem' : '10rem'"
                                >
                                    <div class="header-cell">
                                        <span class="header-title">{{ column.displayName }}</span>
                                        <p-sortIcon [field]="column.name"></p-sortIcon>
                                        <!-- default filter type from column type -->
                                        <p-columnFilter
                                                styleClass="header-filter"
                                                [type]="getFilterType(column)"
                                                [field]="column.name"
                                                display="menu"
                                                [matchMode]="getMatchMode(column)"
                                                [showMatchModes]="getShowMatchModes(column)"
                                        >
                                        <!-- Special-case filter UIs (keep example’s UX) -->
                                        <!-- Representative: multi-select IN filter -->
                                        <ng-template pTemplate="filter" let-value let-filter="filterCallback" *ngIf="isRepresentative(column)">
                                            <p-multiselect
                                                    [(ngModel)]="repFilterModel"
                                                    [options]="representativeOptions"
                                                    optionLabel="name"
                                                [placeholder]="(translationPrefix + '.anyOption') | translate"
                                                    (onChange)="filter($event.value)"
                                                    style="min-width: 14rem"
                                                    [panelStyle]="{ minWidth: '16rem' }"
                                            >
                                                <ng-template pTemplate="item" let-option>
                                                    <div class="flex items-center gap-2">
                                                        <img [alt]="option.name" src="https://primefaces.org/cdn/primeng/images/demo/avatar/{{ option.image }}" style="width: 32px" />
                                                        <span>{{ option.name }}</span>
                                                    </div>
                                                </ng-template>
                                            </p-multiselect>
                                        </ng-template>

                                        <!-- Status: equals on select with Tag preview -->
                                        <ng-template pTemplate="filter" let-value let-filter="filterCallback" *ngIf="isStatus(column)">
                                            <p-select
                                                    [(ngModel)]="statusFilterModel"
                                                    [options]="statusOptions"
                                                    optionLabel="label"
                                                    optionValue="value"
                                                    (onChange)="filter($event.value)"
                                                [placeholder]="(translationPrefix + '.selectOneOption') | translate"
                                                    styleClass="w-full"
                                            >
                                                <ng-template pTemplate="item" let-option>
                                                    <p-tag [value]="option.value" [severity]="getSeverity(option.value)"></p-tag>
                                                </ng-template>
                                            </p-select>
                                        </ng-template>

                                        <!-- Activity: numeric between via slider -->
                                        <ng-template pTemplate="filter" let-value let-filter="filterCallback" *ngIf="isActivity(column)">
                                            <p-slider
                                                    [(ngModel)]="activityRange"
                                                    [range]="true"
                                                    styleClass="m-4"
                                                    (onSlideEnd)="filter(activityRange)"
                                                    [min]="activityMin"
                                                    [max]="activityMax"
                                            ></p-slider>
                                            <div class="flex items-center px-2">
                                                <span>{{ activityRange?.[0] ?? activityMin }} - {{ activityRange?.[1] ?? activityMax }}</span>
                                            </div>
                                        </ng-template>
                                        </p-columnFilter>
                                    </div>
                                </th>
                            }
                        }
                    }
                    @if (showActionColumn) {
                        <th class="actions-header text-center sticky-action">{{ (translationPrefix + '.actions') | translate }}</th>
                    }
                </tr>
            </ng-template>

            <!-- BODY with dynamic cells (keeps your old rendering rules) -->
            <ng-template pTemplate="body" let-record>
                <tr>
                    @for (column of schemaService.visibleColumns(); track column.name) {
                        @if (!isColumnHidden(column.name)) {
                            <td>
                            @switch (column.type) {
                                @case (ColumnType.MINIO_IMAGE) {
                                    <div class="flex items-center gap-2">
                                        @if (resolveImageSource(record[column.name]); as imageSrc) {
                                            <p-image
                                                    [src]="imageSrc"
                                                    [alt]="column.displayName"
                                                    [preview]="true"
                                                    [imageStyle]="{ width: '80px', height: '80px', 'object-fit': 'cover', 'border-radius': '6px', cursor: 'pointer' }"
                                                    [style]="{ 'border-radius': '6px', display: 'inline-flex' }"
                                                    [title]="(translationPrefix + '.viewImage') | translate">
                                            </p-image>
                                        }
                                        @if (imageCount(column, record[column.name]) > 1) {
                                            <span class="text-xs text-surface-500">{{ imageCount(column, record[column.name]) }}/{{ maxImages(column) }}</span>
                                        }
                                        @if (canEdit) {
                                            @if (imageCount(column, record[column.name]) === 0) {
                                                <button type="button"
                                                        pButton
                                                        class="p-button-rounded p-button-outlined p-button-sm"
                                                        (click)="imageInput.click()"
                                                        [disabled]="isImageUploading(record.id, column.name)"
                                                        [aria-label]="(translationPrefix + '.uploadImage') | translate">
                                                    <i class="pi pi-upload"></i>
                                                    <span class="ml-2 hidden md:inline">{{ (translationPrefix + '.uploadImage') | translate }}</span>
                                                </button>
                                            }
                                            @if (isImageUploading(record.id, column.name)) {
                                                <i class="pi pi-spin pi-spinner text-primary"></i>
                                            }
                                            <input #imageInput type="file" accept="image/*"
                                                   (change)="onImageFileSelected($event, record, column)" hidden />
                                        }
                                    </div>
                                }
                                @case (ColumnType.BOOLEAN) {
                                    <i class="pi"
                                       [ngClass]="{
                       'text-green-500 pi-check-circle': record[column.name],
                       'text-red-500 pi-times-circle': !record[column.name]
                     }"></i>
                                }
                                @case (ColumnType.DATE) {
                                    {{ formatDateValue(record[column.name], column) }}
                                }
                                @case (ColumnType.DECIMAL) {
                                    @if (isCplColumn(column)) {
                                        <span class="cpl-chip" [ngClass]="getCplClass(record[column.name])">
                                            {{ formatCplValue(record[column.name]) }}
                                        </span>
                                    } @else {
                                        {{ record[column.name] | number:'1.2-2' }}
                                    }
                                }
                                @default {
                                    <!-- Preserve “example” visuals for known fields if present -->
                                    <ng-container *ngIf="isCountry(column); else notCountry">
                                        <div class="flex items-center gap-2">
                                            <img src="https://primefaces.org/cdn/primeng/images/demo/flag/flag_placeholder.png"
                                                 [class]="'flag flag-' + record[column.name]?.code" style="width: 20px" />
                                            <span>{{ record[column.name]?.name }}</span>
                                        </div>
                                    </ng-container>
                                    <ng-template #notCountry>
                                        <ng-container *ngIf="isRepresentative(column); else notRep">
                                            <div class="flex items-center gap-2">
                                                <img [alt]="record[column.name]?.name"
                                                     src="https://primefaces.org/cdn/primeng/images/demo/avatar/{{ record[column.name]?.image }}"
                                                     width="32" />
                                                <span>{{ record[column.name]?.name }}</span>
                                            </div>
                                        </ng-container>
                                        <ng-template #notRep>
                                            <ng-container *ngIf="isStatus(column); else notStatus">
                                                <p-tag [value]="record[column.name]" [severity]="getSeverity(record[column.name])"></p-tag>
                                            </ng-container>
                                            <ng-template #notStatus>
                                                <ng-container *ngIf="isActivity(column); else plainCell">
                                                    <p-progressbar [value]="record[column.name]" [showValue]="false"></p-progressbar>
                                                </ng-container>
                                                <ng-template #plainCell>
                                                    {{ isDateLikeColumn(column) ? formatDateValue(record[column.name], column) : record[column.name] }}
                                                </ng-template>
                                            </ng-template>
                                        </ng-template>
                                    </ng-template>
                                }
                            }
                            </td>
                        }
                    }
                    @if (showActionColumn) {
                        <td class="actions-cell text-center sticky-action">
                            <div class="flex justify-content-center gap-2">
                                <button
                                        *ngIf="canManageAssignments"
                                        pButton
                                        type="button"
                                        icon="pi pi-user-edit"
                                        class="p-button-rounded p-button-text"
                                        [title]="'orders.actionMenu.assignAgent' | translate"
                                        (click)="openAssignmentDialog(record)"
                                        [disabled]="!record?.id"
                                ></button>
                                <button
                                        *ngIf="canAddNotes"
                                        pButton
                                        type="button"
                                        icon="pi pi-comment"
                                        class="p-button-rounded p-button-text"
                                        [title]="'orders.actionMenu.addNote' | translate"
                                        (click)="openNoteDialog(record)"
                                        [disabled]="!record?.id"
                                ></button>
                                <button
                                        *ngIf="canEdit"
                                        pButton
                                        type="button"
                                        icon="pi pi-pencil"
                                        class="p-button-rounded p-button-text"
                                        (click)="openEditDialog(record.id)"
                                        [disabled]="!record?.id"
                                ></button>
                                <button
                                        *ngIf="canDelete"
                                        pButton
                                        type="button"
                                        icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger"
                                        (click)="confirmDeleteRecord(record.id)"
                                        [disabled]="!record?.id"
                                ></button>
                            </div>
                        </td>
                    }
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td [attr.colspan]="schemaService.visibleColumns().length + (showActionColumn ? 1 : 0)">{{ (translationPrefix + '.noResults') | translate }}</td>
                </tr>
            </ng-template>

            <ng-template pTemplate="loadingbody">
                <tr>
                    <td [attr.colspan]="schemaService.visibleColumns().length + (showActionColumn ? 1 : 0)">
                        <div class="flex align-items-center justify-content-center p-3">
                            <i class="pi pi-spin pi-spinner mr-2"></i>
                            <span>{{ (translationPrefix + '.loading') | translate }}</span>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="footer" *ngIf="adsAggregates && hasRows">
                <tr>
                    <td
                        *ngFor="let column of schemaService.visibleColumns(); trackBy: trackColumn"
                        [ngClass]="{ 'ads-total-cell': true }"
                    >
                        @if (isCplColumn(column)) {
                            <span class="ads-total-label">CPL</span>
                            <span class="ads-total-value">{{ adsAggregates.spend && adsAggregates.leads ? (adsAggregates.spend / adsAggregates.leads) | number:'1.2-2' : '--' }}</span>
                        } @else if (column.name === 'ad_spend') {
                            <span class="ads-total-label">Ad Spend Total</span>
                            <span class="ads-total-value">{{ adsAggregates.spend | number:'1.2-2' }}</span>
                        } @else if (column.name === 'confirmed_orders' || column.name === 'leads' || column.displayName?.toLowerCase() === 'leads') {
                            <span class="ads-total-label">Leads Total</span>
                            <span class="ads-total-value">{{ adsAggregates.leads | number:'1.0-0' }}</span>
                        }
                    </td>
                    <td *ngIf="showActionColumn" class="ads-total-cell"></td>
                </tr>
            </ng-template>
        </p-table>
    </div>

<app-shared-dialog
            [isOpen]="displayDialog"
            [title]="dialogTitle"
            [subtitle]="dialogSubtitle"
            [size]="dialogSize"
            (close)="onDialogCloseRequested($event)"
            [footerActions]="dialogFooterTpl"
            [ariaLabelledBy]="dialogTitleId">
        <form
                #recordForm="ngForm"
                [attr.id]="dialogFormId"
                class="record-form"
                (ngSubmit)="saveRecord(recordForm)"
                [attr.aria-labelledby]="dialogTitleId">
            <div class="dialog-body scrollable" #dialogBody>
                <p-message
                        *ngIf="dialogErrorMessage"
                        severity="error"
                        [text]="dialogErrorMessage"
                        class="dialog-error-message">
                </p-message>

                <div class="dialog-loading" *ngIf="dialogLoading">
                    <p-progressSpinner strokeWidth="4"></p-progressSpinner>
                    <span>{{ 'common.loading' | translate }}</span>
                </div>

                <ng-container *ngIf="!dialogLoading">
                    <ng-container *ngIf="hasVisibleFields; else dialogEmptyState">
                        <div class="formgrid grid dialog-form-grid" #formScroll>
                            <ng-container *ngFor="let column of schemaService.visibleColumns(); trackBy: trackColumn; let idx = index">
                                <div
                                        class="field col-12"
                                        [ngClass]="getFieldContainerClasses(column)"
                                        [attr.data-focus-anchor]="idx === 0 ? 'true' : null">
                                    <label
                                            class="field-label"
                                            [for]="'field-' + column.name">
                                        {{ column.displayName }}
                                        <span *ngIf="column.required" class="required-indicator" aria-hidden="true">*</span>
                                    </label>
                                    <ng-container [ngSwitch]="column.type">
                                        <p-inputNumber
                                                *ngSwitchCase="ColumnType.INTEGER"
                                                [inputId]="'field-' + column.name"
                                                [name]="'field-' + column.name"
                                                [(ngModel)]="formModel[column.name]"
                                                (ngModelChange)="onFieldChange(column.name)"
                                                [useGrouping]="false"
                                                [min]="getNumericRule(column, 'min')"
                                                [max]="getNumericRule(column, 'max')"
                                                [required]="column.required"
                                                [disabled]="isColumnDisabled(column)"
                                                #model="ngModel"
                                                [class.p-invalid]="isFieldInvalid(model)"
                                                [attr.aria-invalid]="isFieldInvalid(model)"
                                                [attr.aria-describedby]="getFieldAriaDescribedBy(column.name, model)">
                                        </p-inputNumber>

                                        <ng-container *ngSwitchCase="ColumnType.DECIMAL">
                                            @if (isCplColumn(column)) {
                                                <div class="cpl-chip" [ngClass]="getCplClass(formModel[column.name])">
                                                    {{ formatCplValue(formModel[column.name]) }}
                                                </div>
                                                <input
                                                        type="hidden"
                                                        [name]="'field-' + column.name"
                                                        [(ngModel)]="formModel[column.name]"
                                                        #model="ngModel">
                                            } @else {
                                                <p-inputNumber
                                                        mode="decimal"
                                                        [minFractionDigits]="getDecimalScale(column)"
                                                        [maxFractionDigits]="getDecimalScale(column)"
                                                        [inputId]="'field-' + column.name"
                                                        [name]="'field-' + column.name"
                                                        [(ngModel)]="formModel[column.name]"
                                                        (ngModelChange)="onFieldChange(column.name)"
                                                        [min]="getNumericRule(column, 'min')"
                                                        [max]="getNumericRule(column, 'max')"
                                                        [required]="column.required"
                                                        [disabled]="isColumnDisabled(column)"
                                                        #model="ngModel"
                                                        [class.p-invalid]="isFieldInvalid(model)"
                                                        [attr.aria-invalid]="isFieldInvalid(model)"
                                                        [attr.aria-describedby]="getFieldAriaDescribedBy(column.name, model)">
                                                </p-inputNumber>
                                            }
                                        </ng-container>

                                        <p-datepicker
                                                *ngSwitchCase="ColumnType.DATE"
                                                [showButtonBar]="false"
                                                [appendTo]="doc.body"
                                                [styleClass]="''"
                                                [panelStyleClass]="''"
                                                [inputId]="'field-' + column.name"
                                                [name]="'field-' + column.name"
                                                [(ngModel)]="formModel[column.name]"
                                                (ngModelChange)="onDateFieldChange(column.name, $event)"
                                                [showIcon]="true"
                                                [iconDisplay]="'input'"
                                                [showOnFocus]="false"
                                                [required]="column.required"
                                                [disabled]="isColumnDisabled(column)"
                                                [dateFormat]="dateDisplayFormat"
                                                #model="ngModel"
                                                [ngClass]="{ 'p-invalid': isFieldInvalid(model) }"
                                                [attr.aria-invalid]="isFieldInvalid(model)"
                                                [attr.aria-describedby]="getFieldAriaDescribedBy(column.name, model)">
                                        </p-datepicker>

                                        <div *ngSwitchCase="ColumnType.MINIO_IMAGE" class="minio-image-dialog">
                                            <div class="image-preview" *ngIf="formModel[column.name]?.items?.length">
                                                <ng-container *ngFor="let image of formModel[column.name].items">
                                                    <p-image
                                                            [src]="image.url"
                                                            [preview]="true"
                                                            [alt]="column.displayName"
                                                            [previewButtonTitle]="(translationPrefix + '.previewImage') | translate"
                                                            class="dialog-image-preview">
                                                    </p-image>
                                                </ng-container>
                                            </div>
                                            <div class="upload-actions flex gap-2 align-items-center mt-2 flex-wrap">
                                                <button
                                                        type="button"
                                                        pButton
                                                        class="p-button-outlined p-button-sm"
                                                        (click)="dialogImageInput.click()"
                                                        [disabled]="isImageUploading('dialog', column.name) || isColumnDisabled(column)"
                                                        [attr.aria-label]="uploadButtonLabel(column)">
                                                    <i class="pi" [ngClass]="canReplaceImage(column, formModel[column.name]) ? 'pi-refresh mr-2' : 'pi-upload mr-2'"></i>
                                                    <span>{{ uploadButtonLabel(column) }}</span>
                                                </button>
                                                <button type="button"
                                                        pButton
                                                        class="p-button-text p-button-sm"
                                                        (click)="clearDialogImage(column)"
                                                        [disabled]="isImageUploading('dialog', column.name) || isColumnDisabled(column)">
                                                    <i class="pi pi-times mr-1"></i>{{ 'common.clear' | translate }}
                                                </button>
                                            </div>
                                            <input
                                                    #dialogImageInput
                                                    type="file"
                                                    accept="image/*"
                                                    (change)="onDialogImageSelected($event, column)"
                                                    hidden />
                                            <small class="field-hint" *ngIf="getImageConstraintsHint(column)">{{ getImageConstraintsHint(column) }}</small>
                                        </div>

                                        <div *ngSwitchCase="ColumnType.BOOLEAN" class="boolean-field">
                                            <p-inputSwitch
                                                    [inputId]="'field-' + column.name"
                                                    [name]="'field-' + column.name"
                                                    [(ngModel)]="formModel[column.name]"
                                                    (ngModelChange)="onFieldChange(column.name)"
                                                    [disabled]="isColumnDisabled(column)"
                                                    #model="ngModel"
                                                    [aria-describedby]="getFieldAriaDescribedBy(column.name, model)">
                                            </p-inputSwitch>
                                            <label [for]="'field-' + column.name" class="boolean-label">
                                                {{ formModel[column.name] ? ('common.yes' | translate) : ('common.no' | translate) }}
                                            </label>
                                        </div>

                                        <ng-container *ngSwitchDefault>
                                            <ng-container *ngIf="hasColumnOptions(column); else defaultTextualInputs">
                                                <p-select
                                                        [options]="getColumnOptions(column)"
                                                        optionLabel="label"
                                                        optionValue="value"
                                                        [filter]="true"
                                                        [showClear]="!column.required"
                                                        [name]="'field-' + column.name"
                                                        [inputId]="'field-' + column.name"
                                                        [(ngModel)]="formModel[column.name]"
                                                        (ngModelChange)="onFieldChange(column.name)"
                                                        [required]="column.required"
                                                        [disabled]="isColumnDisabled(column)"
                                                        #model="ngModel"
                                                        [class.p-invalid]="isFieldInvalid(model)"
                                                        [attr.aria-invalid]="isFieldInvalid(model)"
                                                        [attr.aria-describedby]="getFieldAriaDescribedBy(column.name, model)">
                                                </p-select>
                                            </ng-container>
                                            <ng-template #defaultTextualInputs>
                                                <textarea
                                                        *ngIf="isTextarea(column); else defaultTextInput"
                                                        pInputTextarea
                                                        [name]="'field-' + column.name"
                                                        [id]="'field-' + column.name"
                                                        [(ngModel)]="formModel[column.name]"
                                                        (ngModelChange)="onFieldChange(column.name)"
                                                        [required]="column.required"
                                                        [readonly]="isColumnReadOnly(column)"
                                                        [disabled]="isColumnDisabled(column)"
                                                        [attr.maxLength]="column.maxLength || null"
                                                        #model="ngModel"
                                                        [class.p-invalid]="isFieldInvalid(model)"
                                                        [attr.aria-invalid]="isFieldInvalid(model)"
                                                        [attr.aria-describedby]="getFieldAriaDescribedBy(column.name, model)">
                                                </textarea>
                                                <ng-template #defaultTextInput>
                                                    <input
                                                            pInputText
                                                            type="text"
                                                            [name]="'field-' + column.name"
                                                            [id]="'field-' + column.name"
                                                            [(ngModel)]="formModel[column.name]"
                                                            (ngModelChange)="onFieldChange(column.name)"
                                                            [required]="column.required"
                                                            [readonly]="isColumnReadOnly(column)"
                                                            [disabled]="isColumnDisabled(column)"
                                                            [attr.maxLength]="column.maxLength || null"
                                                            [attr.pattern]="getPatternRule(column)"
                                                            #model="ngModel"
                                                            [class.p-invalid]="isFieldInvalid(model)"
                                                            [attr.aria-invalid]="isFieldInvalid(model)"
                                                            [attr.aria-describedby]="getFieldAriaDescribedBy(column.name, model)">
                                                </ng-template>
                                            </ng-template>
                                        </ng-container>
                                    </ng-container>

                                    <small
                                            *ngIf="getFieldHint(column)"
                                            class="field-hint"
                                            [id]="getFieldHintId(column.name)">
                                        {{ getFieldHint(column) }}
                                    </small>
                                    <small
                                            *ngIf="getFieldError(column, model)"
                                            class="field-error-text"
                                            [id]="getFieldErrorId(column.name)">
                                        {{ getFieldError(column, model) }}
                                    </small>
                                </div>
                            </ng-container>
                        </div>
                    </ng-container>
                </ng-container>
            </div>
        </form>
        <ng-template #dialogEmptyState>
            <div class="dialog-empty-state">
                <i class="pi pi-info-circle"></i>
                <p>{{ (translationPrefix + '.dialog.noFields') | translate:{ component: schemaService.displayName() } }}</p>
            </div>
        </ng-template>

        <ng-template #dialogFooterTpl>
            <div class="dialog-footer-actions">
                <button
                        type="button"
                        pButton
                        class="p-button-text"
                        [label]="'common.cancel' | translate"
                        (click)="onDialogCloseRequested('cancel')"
                        [disabled]="saving || dialogLoading">
                </button>
                <button
                        type="submit"
                        pButton
                        class="p-button-primary"
                        [label]="submitLabel"
                        [loading]="saving"
                        [disabled]="saving || dialogLoading || !hasVisibleFields"
                        [attr.form]="dialogFormId">
                </button>
            </div>
        </ng-template>
</app-shared-dialog>

<p-dialog
        [(visible)]="columnReorderDialogVisible"
        [modal]="true"
        [closable]="!columnOrderSaving"
        [dismissableMask]="!columnOrderSaving"
        [closeOnEscape]="!columnOrderSaving"
        [style]="{ width: '32rem' }"
        [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
        [header]="'common.reorderColumnsTitle' | translate">
    <div class="flex flex-column gap-3">
        <p-message
                severity="info"
                [text]="'common.columnOrderHint' | translate">
        </p-message>

        <ng-container *ngIf="columnOrderModel?.length; else noColumnsOrder">
            <p-orderList
                    [value]="columnOrderModel"
                    [dragdrop]="true"
                    [metaKeySelection]="false"
                    [listStyle]="{ 'max-height': '20rem', 'width': '100%' }"
                    (onReorder)="onColumnOrderReorder($event)">
                <ng-template let-column pTemplate="item">
                    <div class="flex flex-column w-full">
                        <span class="font-medium">{{ column.displayName }}</span>
                        <small class="text-color-secondary">{{ column.name }}</small>
                    </div>
                </ng-template>
            </p-orderList>
        </ng-container>

        <ng-template #noColumnsOrder>
            <p-message
                    severity="warn"
                    [text]="'common.columnOrderEmpty' | translate">
            </p-message>
        </ng-template>
    </div>
    <ng-template pTemplate="footer">
        <button
                pButton
                type="button"
                class="p-button-text"
                [label]="'common.cancel' | translate"
                (click)="columnReorderDialogVisible = false"
                [disabled]="columnOrderSaving">
        </button>
        <button
                pButton
                type="button"
                class="p-button-primary"
                [label]="'common.save' | translate"
                (click)="saveColumnOrder()"
                [disabled]="!(columnOrderModel?.length)"
                [loading]="columnOrderSaving">
        </button>
    </ng-template>
</p-dialog>

<p-dialog
        [(visible)]="assignmentDialogVisible"
        [modal]="true"
        [style]="{ width: '25rem', height: '22rem' }"
        [contentStyle]="{ 'height': '100%', 'overflow': 'auto' }"
        [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
        [header]="'orders.actionMenu.assignDialogTitle' | translate">
    <div class="flex flex-column gap-3">
        <p-select
                [options]="orderAgents"
                optionLabel="username"
                optionValue="id"
                [(ngModel)]="selectedAgentId"
                [loading]="agentsLoading"
                [placeholder]="'orders.actionMenu.assignPlaceholder' | translate">
            <ng-template pTemplate="selectedItem" let-value>
                <div *ngIf="value">{{ value.username }}</div>
            </ng-template>
            <ng-template pTemplate="item" let-option>
                <div class="flex flex-column">
                    <span class="font-medium">{{ option.username }}</span>
                    <small class="text-500" *ngIf="option.email">{{ option.email }}</small>
                </div>
            </ng-template>
        </p-select>
        <p-message *ngIf="!orderAgents.length && !agentsLoading" severity="info" [text]="'orders.actionMenu.assignNoAgents' | translate"></p-message>
    </div>
    <ng-template pTemplate="footer">
        <button pButton type="button" class="p-button-text" [label]="'common.cancel' | translate" (click)="assignmentDialogVisible = false"></button>
        <button pButton type="button" [label]="'orders.actionMenu.assignSubmit' | translate" (click)="submitAssignment()" [loading]="assigningAgent"></button>
    </ng-template>
</p-dialog>

<p-dialog
        [(visible)]="notesDialogVisible"
        [modal]="true"
        [style]="{ width: '25rem' }"
        [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
        [header]="'orders.actionMenu.noteDialogTitle' | translate">
    <div class="flex flex-column gap-2">
        <label for="orderNoteField">{{ 'orders.actionMenu.noteLabel' | translate }}</label>
        <textarea
                id="orderNoteField"
                pInputTextarea
                rows="5"
                [(ngModel)]="noteValue"
                [placeholder]="'orders.actionMenu.notePlaceholder' | translate">
        </textarea>
    </div>
    <ng-template pTemplate="footer">
        <button pButton type="button" class="p-button-text" [label]="'common.cancel' | translate" (click)="notesDialogVisible = false"></button>
        <button pButton type="button" [label]="'common.save' | translate" (click)="saveNote()" [loading]="noteSaving"></button>
    </ng-template>
</p-dialog>
</div>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
