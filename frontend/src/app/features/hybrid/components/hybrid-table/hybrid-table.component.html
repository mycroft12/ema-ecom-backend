<div class="card">
    <div class="font-semibold text-xl mb-4">{{ (translationPrefix + '.title') | translate }}</div>

    <div class="card">
        <p-table
            #dt1
            styleClass="hybrid-table"
            [value]="dataService.records()"
            dataKey="id"
            [rowsPerPageOptions]="[10, 25, 50]"
            [loading]="loading"
            [paginator]="true"
            [lazy]="true"
            [rows]="rows"
            [totalRecords]="totalRecords"
            [first]="first"
            [tableStyle]="{ 'min-width': '1200px' }"
            [scrollable]="true"
            scrollDirection="horizontal"
            [globalFilterFields]="globalFilterFields"
            (onLazyLoad)="onLazyLoad($event)"
            (onSort)="onSort($event)"
        >
            <!-- CAPTION -->
            <ng-template pTemplate="caption">
                <div class="flex flex-wrap items-center gap-2 caption-toolbar">
                    <div class="flex flex-wrap gap-2">
                        <p-button
                                [label]="'common.clear' | translate"
                                [outlined]="true"
                                icon="pi pi-filter-slash"
                                (click)="clear(dt1)"
                        ></p-button>
                        <p-button
                                *ngIf="canAdd"
                                [label]="(translationPrefix + '.newItem') | translate"
                                icon="pi pi-plus"
                                (click)="openCreateDialog()"
                        ></p-button>
                        <p-multiselect
                                class="column-toggle"
                                [options]="columnToggleOptions"
                                [(ngModel)]="selectedColumnKeys"
                                optionLabel="label"
                                optionValue="value"
                                display="chip"
                                [showToggleAll]="false"
                                [placeholder]="(translationPrefix + '.columnTogglePlaceholder') | translate"
                                [selectedItemsLabel]="columnToggleSelectedItemsLabel"
                                (onChange)="onColumnToggleChange($event.value)"
                        ></p-multiselect>
                    </div>
                    <div class="flex items-center gap-2 ml-auto">
                        <p-button
                                *ngIf="canExport"
                                [label]="(translationPrefix + '.exportExcel') | translate"
                                icon="pi pi-file-excel"
                                severity="success"
                                (click)="onExportExcel()"
                                [disabled]="!hasRows"
                                [title]="(translationPrefix + '.exportExcelTooltip') | translate"
                        ></p-button>
                        <p-iconfield iconPosition="left" class="search-field">
                            <p-inputicon>
                                <i class="pi pi-search"></i>
                            </p-inputicon>
                            <input
                                    pInputText
                                    type="text"
                                    [(ngModel)]="searchValue"
                                    (input)="onGlobalFilter($event, dt1)"
                                    [placeholder]="(translationPrefix + '.searchPlaceholder') | translate:{ component: schemaService.displayName() }"
                            />
                        </p-iconfield>
                    </div>
                </div>
            </ng-template>

            <!-- HEADER with dynamic columns and per-column filter UIs -->
            <ng-template pTemplate="header">
                <tr>
                    @for (column of schemaService.visibleColumns(); track column.name) {
                        @if (!isColumnHidden(column.name)) {
                            @if (column.type === ColumnType.MINIO_IMAGE) {
                                <th [style.min-width]="'10rem'">
                                    <div class="header-cell">
                                        <span class="header-title">{{ column.displayName }}</span>
                                    </div>
                                </th>
                            } @else {
                                <th
                                        [pSortableColumn]="column.name"
                                        [style.min-width]="column.type === ColumnType.TEXT ? '15rem' : '10rem'"
                                >
                                    <div class="header-cell">
                                        <span class="header-title">{{ column.displayName }}</span>
                                        <p-sortIcon [field]="column.name"></p-sortIcon>
                                        <!-- default filter type from column type -->
                                        <p-columnFilter
                                                styleClass="header-filter"
                                                [type]="getFilterType(column)"
                                                [field]="column.name"
                                                display="menu"
                                                [matchMode]="getMatchMode(column)"
                                                [showMatchModes]="getShowMatchModes(column)"
                                        >
                                        <!-- Special-case filter UIs (keep example’s UX) -->
                                        <!-- Representative: multi-select IN filter -->
                                        <ng-template pTemplate="filter" let-value let-filter="filterCallback" *ngIf="isRepresentative(column)">
                                            <p-multiselect
                                                    [(ngModel)]="repFilterModel"
                                                    [options]="representativeOptions"
                                                    optionLabel="name"
                                                [placeholder]="(translationPrefix + '.anyOption') | translate"
                                                    (onChange)="filter($event.value)"
                                                    style="min-width: 14rem"
                                                    [panelStyle]="{ minWidth: '16rem' }"
                                            >
                                                <ng-template pTemplate="item" let-option>
                                                    <div class="flex items-center gap-2">
                                                        <img [alt]="option.name" src="https://primefaces.org/cdn/primeng/images/demo/avatar/{{ option.image }}" style="width: 32px" />
                                                        <span>{{ option.name }}</span>
                                                    </div>
                                                </ng-template>
                                            </p-multiselect>
                                        </ng-template>

                                        <!-- Status: equals on select with Tag preview -->
                                        <ng-template pTemplate="filter" let-value let-filter="filterCallback" *ngIf="isStatus(column)">
                                            <p-select
                                                    [(ngModel)]="statusFilterModel"
                                                    [options]="statusOptions"
                                                    optionLabel="label"
                                                    optionValue="value"
                                                    (onChange)="filter($event.value)"
                                                [placeholder]="(translationPrefix + '.selectOneOption') | translate"
                                                    styleClass="w-full"
                                            >
                                                <ng-template pTemplate="item" let-option>
                                                    <p-tag [value]="option.value" [severity]="getSeverity(option.value)"></p-tag>
                                                </ng-template>
                                            </p-select>
                                        </ng-template>

                                        <!-- Activity: numeric between via slider -->
                                        <ng-template pTemplate="filter" let-value let-filter="filterCallback" *ngIf="isActivity(column)">
                                            <p-slider
                                                    [(ngModel)]="activityRange"
                                                    [range]="true"
                                                    styleClass="m-4"
                                                    (onSlideEnd)="filter(activityRange)"
                                                    [min]="activityMin"
                                                    [max]="activityMax"
                                            ></p-slider>
                                            <div class="flex items-center px-2">
                                                <span>{{ activityRange?.[0] ?? activityMin }} - {{ activityRange?.[1] ?? activityMax }}</span>
                                            </div>
                                        </ng-template>
                                        </p-columnFilter>
                                    </div>
                                </th>
                            }
                        }
                    }
                    @if (showActionColumn) {
                        <th class="actions-header text-center sticky-action">{{ (translationPrefix + '.actions') | translate }}</th>
                    }
                </tr>
            </ng-template>

            <!-- BODY with dynamic cells (keeps your old rendering rules) -->
            <ng-template pTemplate="body" let-record>
                <tr>
                    @for (column of schemaService.visibleColumns(); track column.name) {
                        @if (!isColumnHidden(column.name)) {
                            <td>
                            @switch (column.type) {
                                @case (ColumnType.MINIO_IMAGE) {
                                    <div class="flex items-center gap-2">
                                        @if (resolveImageSource(record[column.name]); as imageSrc) {
                                            <p-image
                                                    [src]="imageSrc"
                                                    [alt]="column.displayName"
                                                    [preview]="true"
                                                    [imageStyle]="{ width: '80px', height: '80px', 'object-fit': 'cover', 'border-radius': '6px', cursor: 'pointer' }"
                                                    [style]="{ 'border-radius': '6px', display: 'inline-flex' }"
                                                    [title]="(translationPrefix + '.viewImage') | translate">
                                            </p-image>
                                        }
                                        @if (imageCount(column, record[column.name]) > 1) {
                                            <span class="text-xs text-surface-500">{{ imageCount(column, record[column.name]) }}/{{ maxImages(column) }}</span>
                                        }
                                        @if (canEdit) {
                                            @if (imageCount(column, record[column.name]) === 0) {
                                                <button type="button"
                                                        pButton
                                                        class="p-button-rounded p-button-outlined p-button-sm"
                                                        (click)="imageInput.click()"
                                                        [disabled]="isImageUploading(record.id, column.name)"
                                                        [aria-label]="(translationPrefix + '.uploadImage') | translate">
                                                    <i class="pi pi-upload"></i>
                                                    <span class="ml-2 hidden md:inline">{{ (translationPrefix + '.uploadImage') | translate }}</span>
                                                </button>
                                            }
                                            @if (isImageUploading(record.id, column.name)) {
                                                <i class="pi pi-spin pi-spinner text-primary"></i>
                                            }
                                            <input #imageInput type="file" accept="image/*"
                                                   (change)="onImageFileSelected($event, record, column)" hidden />
                                        }
                                    </div>
                                }
                                @case (ColumnType.BOOLEAN) {
                                    <i class="pi"
                                       [ngClass]="{
                       'text-green-500 pi-check-circle': record[column.name],
                       'text-red-500 pi-times-circle': !record[column.name]
                     }"></i>
                                }
                                @case (ColumnType.DATE) {
                                    {{ record[column.name] | date:'MM/dd/yyyy' }}
                                }
                                @case (ColumnType.DECIMAL) {
                                    {{ record[column.name] | number:'1.2-2' }}
                                }
                                @default {
                                    <!-- Preserve “example” visuals for known fields if present -->
                                    <ng-container *ngIf="isCountry(column); else notCountry">
                                        <div class="flex items-center gap-2">
                                            <img src="https://primefaces.org/cdn/primeng/images/demo/flag/flag_placeholder.png"
                                                 [class]="'flag flag-' + record[column.name]?.code" style="width: 20px" />
                                            <span>{{ record[column.name]?.name }}</span>
                                        </div>
                                    </ng-container>
                                    <ng-template #notCountry>
                                        <ng-container *ngIf="isRepresentative(column); else notRep">
                                            <div class="flex items-center gap-2">
                                                <img [alt]="record[column.name]?.name"
                                                     src="https://primefaces.org/cdn/primeng/images/demo/avatar/{{ record[column.name]?.image }}"
                                                     width="32" />
                                                <span>{{ record[column.name]?.name }}</span>
                                            </div>
                                        </ng-container>
                                        <ng-template #notRep>
                                            <ng-container *ngIf="isStatus(column); else notStatus">
                                                <p-tag [value]="record[column.name]" [severity]="getSeverity(record[column.name])"></p-tag>
                                            </ng-container>
                                            <ng-template #notStatus>
                                                <ng-container *ngIf="isActivity(column); else plainCell">
                                                    <p-progressbar [value]="record[column.name]" [showValue]="false"></p-progressbar>
                                                </ng-container>
                                                <ng-template #plainCell>
                                                    {{ record[column.name] }}
                                                </ng-template>
                                            </ng-template>
                                        </ng-template>
                                    </ng-template>
                                }
                            }
                            </td>
                        }
                    }
                    @if (showActionColumn) {
                        <td class="actions-cell text-center sticky-action">
                            <div class="flex justify-content-center gap-2">
                                <button
                                        *ngIf="canEdit"
                                        pButton
                                        type="button"
                                        icon="pi pi-pencil"
                                        class="p-button-rounded p-button-text"
                                        (click)="openEditDialog(record.id)"
                                        [disabled]="!record?.id"
                                ></button>
                                <button
                                        *ngIf="canDelete"
                                        pButton
                                        type="button"
                                        icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger"
                                        (click)="confirmDeleteRecord(record.id)"
                                        [disabled]="!record?.id"
                                ></button>
                            </div>
                        </td>
                    }
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td [attr.colspan]="schemaService.visibleColumns().length + (showActionColumn ? 1 : 0)">{{ (translationPrefix + '.noResults') | translate }}</td>
                </tr>
            </ng-template>

            <ng-template pTemplate="loadingbody">
                <tr>
                    <td [attr.colspan]="schemaService.visibleColumns().length + (showActionColumn ? 1 : 0)">
                        <div class="flex align-items-center justify-content-center p-3">
                            <i class="pi pi-spin pi-spinner mr-2"></i>
                            <span>{{ (translationPrefix + '.loading') | translate }}</span>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <p-dialog
            [(visible)]="displayDialog"
            [modal]="true"
            [header]="dialogHeader"
            [draggable]="false"
            [resizable]="false"
            [style]="dialogStyle"
            class="record-dialog"
    >
        <form #recordForm="ngForm" (ngSubmit)="saveRecord(recordForm)" class="flex flex-column gap-3">
            <ng-container *ngFor="let column of schemaService.visibleColumns(); trackBy: trackColumn">
                <div class="field">
                    <label [for]="'field-' + column.name">{{ column.displayName }}</label>
                    <ng-container [ngSwitch]="column.type">
                        <input
                                *ngSwitchCase="ColumnType.INTEGER"
                                pInputText
                                type="number"
                                [name]="'field-' + column.name"
                                [id]="'field-' + column.name"
                                [(ngModel)]="formModel[column.name]"
                                [required]="column.required"
                        />
                        <input
                                *ngSwitchCase="ColumnType.DECIMAL"
                                pInputText
                                type="number"
                                step="any"
                                [name]="'field-' + column.name"
                                [id]="'field-' + column.name"
                                [(ngModel)]="formModel[column.name]"
                                [required]="column.required"
                        />
                        <input
                                *ngSwitchCase="ColumnType.DATE"
                                pInputText
                                type="date"
                                [name]="'field-' + column.name"
                                [id]="'field-' + column.name"
                                [(ngModel)]="formModel[column.name]"
                                [required]="column.required"
                        />
                        <div *ngSwitchCase="ColumnType.MINIO_IMAGE" class="flex flex-column gap-2">
                            <div class="flex items-center gap-2">
                                @if (resolveImageSource(formModel[column.name]); as dialogImageSrc) {
                                    <img [src]="dialogImageSrc" [alt]="column.displayName"
                                         style="width: 60px; height: 60px; object-fit: cover;" />
                                } @else {
                                    <span class="flex items-center gap-1 text-sm text-surface-500">
                                        <i class="pi pi-image"></i>
                                        <span>{{ (translationPrefix + '.noImage') | translate }}</span>
                                    </span>
                                }
                                @if (imageCount(column, formModel[column.name]) > 1) {
                                    <span class="text-xs text-surface-500">{{ imageCount(column, formModel[column.name]) }}/{{ maxImages(column) }}</span>
                                }
                                @if (isImageUploading('dialog', column.name)) {
                                    <i class="pi pi-spin pi-spinner text-primary"></i>
                                }
                            </div>
                            <div class="flex gap-2">
                                <button type="button"
                                        pButton
                                        class="p-button-outlined p-button-sm"
                                        (click)="dialogImageInput.click()"
                                        [disabled]="isImageUploading('dialog', column.name)"
                                        [aria-label]="canReplaceImage(column, formModel[column.name]) ? ( (translationPrefix + '.replaceImage') | translate ) : ( (translationPrefix + '.uploadImage') | translate )">
                                    <i class="pi" [ngClass]="canReplaceImage(column, formModel[column.name]) ? 'pi-refresh mr-2' : 'pi-upload mr-2'"></i>
                                    <span>{{ canReplaceImage(column, formModel[column.name]) ? ((translationPrefix + '.replaceImage') | translate) : ((translationPrefix + '.uploadImage') | translate) }}</span>
                                </button>
                                <button type="button"
                                        pButton
                                        class="p-button-text p-button-sm"
                                        (click)="clearDialogImage(column)"
                                        [disabled]="isImageUploading('dialog', column.name)">
                                    <i class="pi pi-times mr-1"></i>{{ 'common.clear' | translate }}
                                </button>
                            </div>
                            <input #dialogImageInput type="file" accept="image/*"
                                   (change)="onDialogImageSelected($event, column)" hidden />
                        </div>
                        <div *ngSwitchCase="ColumnType.BOOLEAN" class="flex align-items-center gap-2">
                            <input
                                    type="checkbox"
                                    [name]="'field-' + column.name"
                                    [id]="'field-' + column.name"
                                    [(ngModel)]="formModel[column.name]"
                            />
                            <label [for]="'field-' + column.name" class="mb-0">{{ formModel[column.name] ? ('common.yes' | translate) : ('common.no' | translate) }}</label>
                        </div>
                        <input
                                *ngSwitchDefault
                                pInputText
                                type="text"
                                [name]="'field-' + column.name"
                                [id]="'field-' + column.name"
                                [(ngModel)]="formModel[column.name]"
                                [required]="column.required"
                        />
                    </ng-container>
                </div>
            </ng-container>
            <div class="flex justify-content-end gap-2">
                <button
                        type="button"
                        pButton
                        class="p-button-text"
                        [label]="'common.cancel' | translate"
                        (click)="closeDialog()"
                        [disabled]="saving"
                ></button>
                <button
                        type="submit"
                        pButton
                        [label]="submitLabel"
                        [loading]="saving"
                ></button>
            </div>
        </form>
    </p-dialog>
</div>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
